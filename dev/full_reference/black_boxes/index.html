<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Black Boxes ¬∑ DiffPrivacyInference</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DiffPrivacyInference</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Overview</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../getting_started/installation/">Installation</a></li><li><a class="tocitem" href="../../getting_started/quick_guide/">Quick Guide</a></li></ul></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../../tutorial/01_sensitivity_functions/">Sensitivity functions</a></li><li><a class="tocitem" href="../../tutorial/02_privacy_functions/">Privacy functions</a></li><li><a class="tocitem" href="../../tutorial/03_flux_dp/">Learning MNIST using <code>Flux.jl</code>, verified differentially private</a></li></ul></li><li><span class="tocitem">Full Reference</span><ul><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../syntax/">Supported julia syntax</a></li><li><a class="tocitem" href="../annotations/">Annotations</a></li><li><a class="tocitem" href="../builtins/">Builtins</a></li><li class="is-active"><a class="tocitem" href>Black Boxes</a><ul class="internal"><li><a class="tocitem" href="#Syntax"><span>Syntax</span></a></li><li><a class="tocitem" href="#Warning:-do-not-mutate!"><span>Warning: do not mutate!</span></a></li><li><a class="tocitem" href="#Warning:-do-not-let-references-to-input-arguments-through!"><span>Warning: do not let references to input arguments through!</span></a></li><li><a class="tocitem" href="#The-interesting-special-case"><span>The interesting special case</span></a></li></ul></li><li><a class="tocitem" href="../demutation/">Demutation system</a></li><li><a class="tocitem" href="../scoping_rules/">Scoping rules</a></li><li><a class="tocitem" href="../measuring_distance/">Measuring Distance</a></li><li><a class="tocitem" href="../types/">Types</a></li><li><a class="tocitem" href="../constraints/">Constraints</a></li></ul></li><li><span class="tocitem">Development Notes</span><ul><li><a class="tocitem" href="../../development_notes/updating_haskell/">Managing the two repositories</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Full Reference</a></li><li class="is-active"><a href>Black Boxes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Black Boxes</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/DiffMu/DiffPrivacyInference.jl/blob/master/docs/src/full_reference/black_boxes.md" title="Edit on GitHub"><span class="docs-icon fab">ÔÇõ</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="black-boxes"><a class="docs-heading-anchor" href="#black-boxes">Black Boxes</a><a id="black-boxes-1"></a><a class="docs-heading-anchor-permalink" href="#black-boxes" title="Permalink"></a></h1><p>The code that we can infer sensitivity/privacy properties of is limited to the <a href="../syntax/#syntax">supported syntax</a>. In case the program you want to analyze contains pieces of code that are not supported, you can do so by telling the typechecker to assume that those parts of your code have infinitely bad sensitivity properties. This might sound like it&#39;s not very useful, but there are situations in which it actually is.</p><h2 id="Syntax"><a class="docs-heading-anchor" href="#Syntax">Syntax</a><a id="Syntax-1"></a><a class="docs-heading-anchor-permalink" href="#Syntax" title="Permalink"></a></h2><p>You need to wrap the non-checkable code in a so called &quot;Black box function&quot;, by annotating the function definition using this syntax:</p><pre><code class="language-julia hljs">loss(X, y, m) :: BlackBox() = Flux.crossentropy(m.model(X), y)</code></pre><p>Note that you can only define black boxes in the outermost scope of your code (not as an inner function, for instance). Further, black boxes cannot have multiple methods.</p><p>As the code in the function body is not analyzed, we cannot infer the return type. Upon invocation of a black box function, you hence have to specify the expected return type using the builtin <a href="full_reference/@ref"><code>unbox</code></a>. This will produce a runtime assertion on the return type. The annotation must be one of the <a href="../annotations/#annotations">supported julia types</a>, and must match exactly (i.e. if the function returns an <code>Integer</code> and you annotated <code>Real</code>, you will get an error). This  Here&#39;s an example on how to call the previously defined <code>loss</code> function:</p><pre><code class="language-julia hljs">function foo(m, x)
   res = unbox(loss(x, x, m), Real)
   res
end</code></pre><p>This function can be typechecked, even though the executed code uses a function call to <code>Flux.jl</code>, which is not allowed other than inside black boxes. This example still ist not very useful, as both arguments have infinite sensitivity ‚Äì the typechecker cannot tell what happens with them inside the black box, so it assumes the worst.</p><p>For container types like <code>Matrix</code>, <code>Vector</code> and <code>DMGrads</code> you will have to specify the dimension of the output as well, which will also be runtime-asserted. Here&#39;s a slightly more involved example:</p><pre><code class="language-julia hljs">function unbounded_gradient(m::DMModel, data, label) :: BlackBox()
   gs = Flux.gradient(Flux.params(model.model)) do
           Flux.crossentropy(m.model(data),label)
        end
   return DMGrads(gs)
end</code></pre><p>This already does something quite interesting, namely using the <code>Flux.jl</code> autodiff facilities to compute a gradient. A typecheckable call to it might look like this:</p><pre><code class="language-julia hljs">function compute_gradient(model, n_params, data, labels)
   gs = unbox(unbounded_gradient(model, data, labels), DMGrads, n_params)
   gs
end</code></pre><p>But, again, the sensitivity of all arguments except <code>n_params</code> will be infinite, so this is not very useful. Behold the following warning before being presented with an example that is, in fact, interesting.</p><h2 id="Warning:-do-not-mutate!"><a class="docs-heading-anchor" href="#Warning:-do-not-mutate!">Warning: do not mutate!</a><a id="Warning:-do-not-mutate!-1"></a><a class="docs-heading-anchor-permalink" href="#Warning:-do-not-mutate!" title="Permalink"></a></h2><p>The typechecker completely ignores the code in the body of a black-box function. You can do anything you like in there, except one thing: mutating the arguments or global state. You will not recieve any warnings or errors about this during typechecking, so be careful. If you do, the analysis result will be invalid.</p><h2 id="Warning:-do-not-let-references-to-input-arguments-through!"><a class="docs-heading-anchor" href="#Warning:-do-not-let-references-to-input-arguments-through!">Warning: do not let references to input arguments through!</a><a id="Warning:-do-not-let-references-to-input-arguments-through!-1"></a><a class="docs-heading-anchor-permalink" href="#Warning:-do-not-let-references-to-input-arguments-through!" title="Permalink"></a></h2><p>There is a second property which is required for correctness of the result, yet which cannot be checked automatically for black boxes: You have to make sure that the return value of the function does not contain references to the input arguments, or global variables. See <a href="../demutation/#mut_type_black_box">here</a> for some details.</p><h2 id="The-interesting-special-case"><a class="docs-heading-anchor" href="#The-interesting-special-case">The interesting special case</a><a id="The-interesting-special-case-1"></a><a class="docs-heading-anchor-permalink" href="#The-interesting-special-case" title="Permalink"></a></h2><p>As you may read in the documentation on <a href="../measuring_distance/#measuring-distance">measuring distance</a>, container types carry information on the metric that is used for the definition of sensitivity. A special property of the <code>(LInf, ùîª)</code>-metric and other discrete metrics on container types is this:</p><p class="math-container">\[\text{Functions from ùîª-matrices, -vectors or -gradients to (L‚àû, ùîª)-vectors or -gradients are 1-sensitive.}\]</p><p>This means if you take care for your black box function to have the correct input and output types, it will be 1-sensitive! A modification of the above code suffices:</p><pre><code class="language-julia hljs">function compute_gradient(model, n_params, data::Vector{&lt;:Data}, labels::Vector{&lt;:Data})
   gs = unbox(unbounded_gradient(model, data, labels), MetricGradient(Data, LInf), n_params)
   gs
end</code></pre><p>The inferred sensitivity for the <code>data</code> and <code>labels</code> arguments is 1. Make sure you understand what annotating them in this way means for the interpretation of this result: The sensitivity is is now measured with respect to some <em>discrete</em> metric on the input vectors and the <code>(LInf, ùîª)</code>-metric on the output gradient. In particular, these are not your standard euclidean vectors, so make sure this is what you actually want or take care to convert the results properly. See the <a href="full_reference/@ref">flux-dp example</a> walkthrough for a more detailed explanation of this particular application.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../builtins/">¬´ Builtins</a><a class="docs-footer-nextpage" href="../demutation/">Demutation system ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.17 on <span class="colophon-date" title="Wednesday 11 May 2022 12:10">Wednesday 11 May 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
